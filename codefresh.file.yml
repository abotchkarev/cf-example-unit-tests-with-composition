version: '1.0'
steps:

    build_step:
      type: build
      image_name: codefreshio/yaml-example-unit-test-compose
      dockerfile: Dockerfile
      tag: ${{CF_BRANCH}}
      when:
        condition:
          cond1:
              noSkipCiInCommitMessage: 'includes(lower("${{CF_COMMIT_MESSAGE}}"), "--skip-ci") == false'
              notMasterBranch: '"${{CF_BRANCH}}" != "master"'
          cond2:
              noSkipDeployInCommitMessage: 'includes(lower("${{CF_COMMIT_MESSAGE}}"), "--skip-deploy") == false'
              masterBranch: '"${{CF_BRANCH}}" == "test1"

    unit_test:
      type: composition
      working_directory: ${{main_clone}}
      composition: ./docker-compose.yml
      composition_candidates:
        test:
          image: ${{build_step}}
          command: bash -c 'sleep 30 && MYSQL_ROOT_PASSWORD=admin MYSQL_USER=my_user MYSQL_HOST=db MYSQL_PASSWORD=admin MYSQL_DATABASE=nodejs npm test'